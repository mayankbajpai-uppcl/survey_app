<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Door-to-Door Survey App</title>
    
    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        body { display: flex; min-height: 100vh; flex-direction: column; }
        main { flex: 1 0 auto; padding: 20px; }
        .card { padding: 20px; }
        .hidden { display: none; }
        #photoPreview { max-width: 100%; height: auto; margin-top: 10px; }
    </style>
</head>
<body>

<main>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="container">
        <h4 class="center">Survey App Login</h4>
        <div class="row">
            <div class="input-field col s12">
                <input id="userId" type="text">
                <label for="userId">Admin/Surveyor ID</label>
            </div>
            <div class="input-field col s12">
                <input id="password" type="password">
                <label for="password">Password</label>
            </div>
            <div class="col s12 center">
                <button class="btn waves-effect waves-light" onclick="handleLogin()">Login</button>
            </div>
        </div>
    </div>

    <!-- SURVEYOR DASHBOARD -->
    <div id="surveyorDashboard" class="hidden container">
        <h5 class="center">Surveyor Dashboard</h5>
        <div class="card">
            <h6>Submit New Survey</h6>
            <div class="row">
                <div class="input-field col s12">
                    <input id="accountId" type="text">
                    <label for="accountId">Account ID</label>
                </div>
                <div class="file-field input-field col s12">
                    <div class="btn">
                        <span>House Photo</span>
                        <input type="file" id="housePhoto" accept="image/*" capture="environment">
                    </div>
                    <div class="file-path-wrapper">
                        <input class="file-path validate" type="text" placeholder="Upload house photo">
                    </div>
                </div>
                <img id="photoPreview" class="hidden" />
                <div class="col s12 center">
                    <button class="btn waves-effect waves-light" onclick="handleSurveySubmit()">Submit Survey</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h6>Search Survey</h6>
            <div class="row">
                <div class="input-field col s12">
                    <input id="searchAccountId" type="text">
                    <label for="searchAccountId">Account ID</label>
                </div>
                <div class="col s12 center">
                    <button class="btn waves-effect waves-light" onclick="handleSearch()">Search</button>
                </div>
                <div id="searchResult" class="col s12 hidden">
                    <p><strong>Surveyor ID:</strong> <span id="surveyorId"></span></p>
                    <p><strong>Latitude:</strong> <span id="latitude"></span></p>
                    <p><strong>Longitude:</strong> <span id="longitude"></span></p>
                    <img id="photo" src="" alt="House Photo">
                </div>
            </div>
        </div>

        <div class="col s12 center">
            <button class="btn red lighten-1" onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- ADMIN DASHBOARD -->
    <div id="adminDashboard" class="hidden container">
        <h5 class="center">Admin Dashboard</h5>

        <div class="card">
            <h6>Add Surveyor</h6>
            <div class="row">
                <div class="input-field col s6">
                    <input id="newSurveyorId" type="text">
                    <label for="newSurveyorId">Surveyor ID</label>
                </div>
                <div class="input-field col s6">
                    <input id="newSurveyorPass" type="password">
                    <label for="newSurveyorPass">Password</label>
                </div>
                <div class="col s12 center">
                    <button class="btn waves-effect waves-light" onclick="handleAddSurveyor()">Add Surveyor</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h6>View All Surveys</h6>
            <table class="highlight responsive-table">
                <thead>
                    <tr>
                        <th>Row</th>
                        <th>Account ID</th>
                        <th>Surveyor ID</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Photo</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="surveyTableBody"></tbody>
            </table>
        </div>

        <div class="col s12 center">
            <button class="btn red lighten-1" onclick="logout()">Logout</button>
        </div>
    </div>
</main>

<!-- Materialize JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

<script>
    // ------------------- Backend API -------------------
    const API_URL = "https://script.google.com/macros/s/AKfycbwxDtCbdKN3fmDTIzreLKAH6KsxA_T_8Dn7aaGB62olZ5aJM69iKg3MCbNBiMBjIPnMYw/exec";

    async function apiFetch(path, data=null) {
        const options = { method: data?"POST":"GET", headers:{"Content-Type":"application/json"} };
        if(data) options.body = JSON.stringify(data);
        let url = API_URL;
        if(!data) {
            const params = new URLSearchParams({path, ...data}).toString();
            url = `${API_URL}?${params}`;
        } else {
            url += `?path=${path}`;
        }
        try{
            const res = await fetch(url, options);
            return await res.json();
        }catch(err){ console.error(err); return {status:"error", message: err.message}; }
    }

    function logout(){
        localStorage.removeItem("token");
        localStorage.removeItem("userType");
        location.reload();
    }

    // ------------------- Login -------------------
    async function handleLogin(){
        const userId = document.getElementById("userId").value.trim();
        const password = document.getElementById("password").value.trim();
        if(!userId||!password) return alert("Enter ID and Password");

        // Admin first, fallback to surveyor
        let res = await apiFetch("loginAdmin",{adminId:userId,password});
        if(res.status==="success"){
            localStorage.setItem("token", res.token);
            localStorage.setItem("userType","admin");
            showAdminDashboard();
            return;
        }
        res = await apiFetch("loginSurveyor",{surveyorId:userId,password});
        if(res.status==="success"){
            localStorage.setItem("token", res.token);
            localStorage.setItem("userType","surveyor");
            showSurveyorDashboard();
            return;
        }
        alert("Login failed!");
    }

    // ------------------- Show Dashboards -------------------
    function showLoginScreen(){ document.getElementById("loginScreen").classList.remove("hidden"); }
    function showSurveyorDashboard(){ 
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("surveyorDashboard").classList.remove("hidden");
    }
    function showAdminDashboard(){
        document.getElementById("loginScreen").classList.add("hidden");
        document.getElementById("adminDashboard").classList.remove("hidden");
        loadSurveys();
    }

    // ------------------- Surveyor: Submit Survey -------------------
    function fileToBase64(file){
        return new Promise((resolve,reject)=>{
            const reader=new FileReader();
            reader.onload=()=>resolve(reader.result.split(",")[1]);
            reader.onerror=reject;
            reader.readAsDataURL(file);
        });
    }

    function getCurrentLocation(){
        return new Promise((resolve,reject)=>{
            navigator.geolocation.getCurrentPosition(
                pos=>resolve({latitude:pos.coords.latitude,longitude:pos.coords.longitude}),
                err=>reject(err)
            );
        });
    }

    async function handleSurveySubmit(){
        const accountId = document.getElementById("accountId").value.trim();
        const file = document.getElementById("housePhoto").files[0];
        if(!accountId||!file) return alert("Enter Account ID and select photo");
        const imageBase64 = await fileToBase64(file);
        const {latitude,longitude} = await getCurrentLocation();
        const surveyorId = localStorage.getItem("token"); // token as surveyorId

        const res = await apiFetch("submitSurvey",{accountId,surveyorId,imageBase64,latitude,longitude});
        if(res.status==="success") alert("Survey submitted!");
        else if(res.status==="duplicate") alert("Account ID already exists!");
        else alert("Error submitting survey.");
    }

    // ------------------- Surveyor: Search -------------------
    async function handleSearch(){
        const accountId = document.getElementById("searchAccountId").value.trim();
        if(!accountId) return alert("Enter Account ID");
        const res = await apiFetch("search",{accountId});
        const resultDiv = document.getElementById("searchResult");
        if(res.status==="not found") return alert("Survey not found.");
        resultDiv.classList.remove("hidden");
        document.getElementById("surveyorId").textContent = res.surveyorId;
        document.getElementById("latitude").textContent = res.latitude;
        document.getElementById("longitude").textContent = res.longitude;
        document.getElementById("photo").src = res.photoUrl;
    }

    // ------------------- Admin: Add Surveyor -------------------
    async function handleAddSurveyor(){
        const id=document.getElementById("newSurveyorId").value.trim();
        const pass=document.getElementById("newSurveyorPass").value.trim();
        if(!id||!pass) return alert("Enter ID and password");
        const res = await apiFetch("addSurveyor",{id,pass});
        if(res.status==="success") alert("Surveyor added!");
        else alert("Error adding surveyor");
        loadSurveys();
    }

    // ------------------- Admin: Load Surveys -------------------
    async function loadSurveys(){
        const res = await apiFetch("getSurveys");
        const tbody=document.getElementById("surveyTableBody");
        tbody.innerHTML="";
        if(res.rows){
            res.rows.slice(1).forEach((row,i)=>{
                const tr=document.createElement("tr");
                tr.innerHTML=`
                    <td>${i+2}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td><a href="${row[5]}" target="_blank">View Photo</a></td>
                    <td><button class="btn red btn-small" onclick="deleteSurvey(${i+2})">Delete</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    async function deleteSurvey(row){
        const res = await apiFetch("deleteSurvey",{row});
        if(res.status==="deleted") loadSurveys();
        else alert("Error deleting survey");
    }

    // ------------------- Persistent login check -------------------
    document.addEventListener("DOMContentLoaded",()=>{
        const token=localStorage.getItem("token");
        const userType=localStorage.getItem("userType");
        if(token && userType){
            if(userType==="admin") showAdminDashboard();
            else if(userType==="surveyor") showSurveyorDashboard();
        } else showLoginScreen();
    });
</script>

</body>
</html>
